services:
  charterafrica:
    build:
      secrets:
        - mongo_url
        - payload_secret
        - sentry_auth_token
        - sentry_org
        - sentry_project
        - payload_secret_key
      context: .
      target: charterafrica-runner
      args:
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
    env_file:
      - path: ./apps/charterafrica/.env
      - path: ./apps/charterafrica/.env.local
        required: false
    ports:
      - 3000:3000

  civicsignalblog:
    build:
      secrets:
        - mongo_url
        - payload_secret
        - sentry_auth_token
        - sentry_org
        - sentry_project
      context: .
      target: civicsignalblog-runner
      args:
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
    env_file:
      - path: ./apps/civicsignalblog/.env
      - path: ./apps/civicsignalblog/.env.local
        required: false
    ports:
      - 3000:3000

  climatemappedafrica:
    build:
      secrets:
        - mongo_url
        - payload_secret
        - sentry_auth_token
        - sentry_org
        - sentry_project
      context: .
      target: climatemappedafrica-runner
      args:
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
    env_file:
      - path: ./apps/climatemappedafrica/.env
      - path: ./apps/climatemappedafrica/.env.local
        required: false
    ports:
      - 3000:3000

  codeforafrica:
    build:
      secrets:
        - mongodb_url
        - payload_secret
        - sentry_auth_token
        - sentry_org
        - sentry_project
      context: .
      target: codeforafrica-runner
      args:
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
    env_file:
      - path: ./apps/codeforafrica/.env
      - path: ./apps/codeforafrica/.env.local
        required: false
    ports:
      - 3000:3000

  mongodb:
    image: mongo:6.0.13
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-rootpassword}
    ports:
      - 27017:27017
    volumes:
      - db_data:/data/db
      - ./mongo-keyfile:/etc/mongo-keyfile
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      # https://medium.com/workleap/the-only-local-mongodb-replica-set-with-docker-compose-guide-youll-ever-need-2f0b74dd8384
      test: echo "try { rs.status() } catch (err) { rs.initiate({_id:'rs0',members:[{_id:0,host:'host.docker.internal:27017'}]}) }" | mongosh --port 27017 --quiet
      interval: 5s
      timeout: 30s
      start_period: 0s
      retries: 30
    command:
      ["--replSet", "rs0", "--bind_ip_all", "--keyFile", "/etc/mongo-keyfile"]

  pesayetu:
    build:
      secrets:
        - jwt_secret_key
        - sentry_auth_token
        - sentry_org
        - sentry_project
        - wordpress_application_password
        - wordpress_application_username
        - wordpress_preview_secret
      context: .
      target: pesayetu-runner
      args:
        - HURUMAP_API_URL=${HURUMAP_API_URL}
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
        - WORDPRESS_URL=${WORDPRESS_URL}
    env_file:
      - path: ./apps/pesayetu/.env
      - path: ./apps/pesayetu/.env.local
        required: false
    ports:
      - 3000:3000

  roboshield:
    build:
      secrets:
        - mongo_url
        - payload_secret
        - sentry_auth_token
        - sentry_org
        - sentry_project
      context: .
      target: roboshield-runner
      args:
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
    env_file:
      - path: ./apps/roboshield/.env
      - path: ./apps/roboshield/.env.local
        required: false
    ports:
      - 3000:3000

  techlabblog:
    build:
      secrets:
        - sentry_auth_token
        - sentry_org
        - sentry_project
      context: .
      target: techlabblog-runner
      args:
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
    env_file:
      - path: ./apps/techlabblog/.env
      - path: ./apps/techlabblog/.env.local
        required: false
    ports:
      - 3000:3000

  trustlab:
    build:
      # env_file attribute is for runtime
      # We need args to be available at build time & hence we need to
      # specify them here; they come from --env-file command-line argument(s)
      args:
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
        - SMTP_HOST=${SMTP_HOST}
        - SMTP_USER=${SMTP_USER}
      context: .
      secrets:
        - mongo_url
        - payload_secret
        - sentry_auth_token
        - sentry_org
        - sentry_project
        - smtp_pass
      target: trustlab-runner
    env_file:
      - path: ./apps/trustlab/.env
      - path: ./apps/trustlab/.env.local
        required: false
    image: codeforafrica/trustlab-ui:${IMAGE_TAG}
    ports:
      - 3000:3000
    # Force to always build just in case there is a matching tag in the registry
    pull_policy: build

  twoopstracker:
    build:
      secrets:
        - sentry_auth_token
        - sentry_org
        - sentry_project
      context: .
      target: twoopstracker-runner
      args:
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
        - TWOOPSTRACKER_API_URL=${TWOOPSTRACKER_API_URL}
    env_file:
      - path: ./apps/twoopstracker/.env
      - path: ./apps/twoopstracker/.env.local
    ports:
      - 3000:3000

  vpnmanager:
    build:
      secrets:
        - api_secret_key
        - sentry_auth_token
        - sentry_org
        - sentry_project
      context: .
      target: vpnmanager-runner
      args:
        - SENTRY_DSN=${SENTRY_DSN}
        - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
    env_file:
      - path: ./apps/vpnmanager/.env
      - path: ./apps/vpnmanager/.env.local
    ports:
      - ${VPN_MANAGER_PORT:-3000}:3000
    volumes:
      - ./db_data:/apps/vpnmanager/data

  promisetracker:
    build:
      secrets:
        - sentry_auth_token
        - sentry_org
        - sentry_project
      context: .
      target: promisetracker-runner
      args:
        - SENTRY_DSN=${SENTRY_DSN}
    env_file:
      - path: ./apps/promisetracker/.env
      - path: ./apps/promisetracker/.env.local
        required: false
    ports:
      - ${PROMISE_TRACKER_PORT:-3000}:3000

secrets:
  api_secret_key:
    environment: API_SECRET_KEY
  jwt_secret_key:
    environment: JWT_SECRET_KEY
  mongo_url:
    environment: MONGO_URL
  mongodb_url:
    environment: MONGODB_URL
  payload_secret:
    environment: PAYLOAD_SECRET
  payload_secret_key:
    environment: PAYLOAD_SECRET_KEY
  sentry_auth_token:
    environment: SENTRY_AUTH_TOKEN
  sentry_org:
    environment: SENTRY_ORG
  sentry_project:
    environment: SENTRY_PROJECT
  smtp_pass:
    environment: SMTP_PASS
  wordpress_application_password:
    environment: WORDPRESS_APPLICATION_PASSWORD
  wordpress_application_username:
    environment: WORDPRESS_APPLICATION_USERNAME
  wordpress_preview_secret:
    environment: WORDPRESS_PREVIEW_SECRET

volumes:
  db_data:
