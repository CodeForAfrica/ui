name: CD | codeforafrica

on:
  workflow_call:
    inputs:
      app_url:
        required: true
        type: string
        description: "App final URL"
      NODE_ENV:
        required: true
        type: string
        description: "development|production"
      build_args:
        required: false
        type: string
        description: "List of build-time variables"
      tags:
        required: true
        type: string
        description: "List of tags"
      git_remote_url:
        required: true
        type: string
        description: "The dokku app's git repository url in SSH format"

jobs:
  build-docker-image:
    name: Build Docker Image
    uses: ./.github/workflows/build-docker-image.yml
    with:
      build_args: |
        ${{ inputs.build_args }}
        MONGODB_URL=${{ secrets.CODEFORAFRICA_MONGODB_URL }}
        NEXT_PUBLIC_APP_LOGO_URL=${{ secrets.NEXT_PUBLIC_CODEFORAFRICA_APP_LOGO_URL }}
        NEXT_PUBLIC_APP_NAME=${{ secrets.NEXT_PUBLIC_CODEFORAFRICA_APP_NAME }}
        NEXT_PUBLIC_APP_URL=${{ inputs.app_url }}
        NODE_ENV=${{ inputs.NODE_ENV }}
        PAYLOAD_SECRET=${{ secrets.CODEFORAFRICA_PAYLOAD_SECRET }}
        SENTRY_ENVIRONMENT=${{ inputs.NODE_ENV }}
        SENTRY_PROJECT=${{ secrets.CODEFORAFRICA_SENTRY_PROJECT }}
        SENTRY_DSN: ${{ vars.TECHLABBLOG_SENTRY_DSN }}
      tags: ${{ inputs.tags }}
      target: "codeforafrica-runner"
    secrets: inherit

  push-to-dokku:
    name: Push to Dokku
    needs: [build-docker-image]
    uses: ./.github/workflows/push-to-dokku.yml
    with:
      git_remote_url: ${{ inputs.git_remote_url }}
      deploy_docker_image: ${{ inputs.tags }}
    secrets: inherit
