name: Techlab Blog | Deploy Dev

on:
  push:
    branches: [main]
    paths:
      - "apps/techlabblog/**"
      - "Dockerfile"
      - ".github/workflows/techlabblog-deploy-dev.yml"

# This allows a subsequently queued workflow run to interrupt previous runs
concurrency:
  group: "${{ github.workflow }} @ ${{ github.ref }}"
  cancel-in-progress: true

env:
  SENTRY_ENVIRONMENT: "development"
  SENTRY_ORG: "codeforafrica"
  SENTRY_DSN: ${{ secrets.TECHLABBLOG_SENTRY_DSN }}
  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

jobs:
  env-setup:
    runs-on: ubuntu-latest
    outputs:
      DOKKU_REMOTE_URL: ${{ steps.env-setup.outputs.DOKKU_REMOTE_URL }}
      DOKKU_PRIVATE_KEY: ${{ steps.env-setup.outputs.DOKKU_PRIVATE_KEY }}
      SENTRY_ORG: ${{ steps.env-setup.outputs.SENTRY_ORG }}
      SENTRY_DSN: ${{ steps.env-setup.outputs.SENTRY_DSN }}
      SENTRY_AUTH_TOKEN: ${{ steps.env-setup.outputs.SENTRY_AUTH_TOKEN }}
      SENTRY_ENVIRONMENT: ${{ steps.env-setup.outputs.SENTRY_ENVIRONMENT }}
    steps:
      - name: Environment Setup
        id: env-setup
        run: |
          echo "SENTRY_ORG=${{ env.SENTRY_ORG }}" >> $GITHUB_ENV
          echo "SENTRY_DSN=${{ env.TECHLABBLOG_SENTRY_DSN }}" >> $GITHUB_ENV
          echo "SENTRY_AUTH_TOKEN=${{ env.SENTRY_AUTH_TOKEN }}" >> $GITHUB_ENV
          echo "SENTRY_ENVIRONMENT=${{ env.SENTRY_ENVIRONMENT }}" >> $GITHUB_ENV

  build-docker-image:
    needs: [env-setup]
    uses: ./.github/workflows/build-docker-image.yml
    secrets: inherit
    with:
      tags: "codeforafrica/techlabblog:${{ github.sha }}"
      target: "techlabblog-runner"
      build_args: |
        SENTRY_AUTH_TOKEN=${{ needs.env-setup.outputs.SENTRY_AUTH_TOKEN }}
        SENTRY_ENVIRONMENT=${{ needs.env-setup.outputs.SENTRY_ENVIRONMENT }}
        SENTRY_ORG: ${{ needs.env-setup.outputs.SENTRY_ORG }}
        SENTRY_DSN: ${{ needs.env-setup.outputs.SENTRY_DSN }}

  push-to-dokku:
    needs: [build-docker-image, env-setup]
    uses: ./.github/workflows/push-to-dokku.yml
    secrets: inherit
    with:
      remote_url: "ssh://azureuser@ui-1.dev.codeforafrica.org/techlabblog"
      image_name: "codeforafrica/techlabblog:${{ github.sha }}"
